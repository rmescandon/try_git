name: CI
on:
  pull_request_review:
    types: [submitted]
    branches: [master]

jobs:
  build:
    # The job runs on default machine
    runs-on: self-hosted
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout this repo branch
        uses: actions/checkout@v2
        if: github.event.review.state == 'approved' && github.event.pull_request.base.ref == 'master'
      - name: Merge candidate into master
        run: |
          # echo number of reviewers:
          echo "${{ github.event.pull_request }}"

          # create candidate branch based on pulled
          export CANDIDATE="$(echo $RANDOM | md5sum | head -c 20; echo;)"
          git checkout -b ${CANDIDATE}
          # Adding unshallow to pevent git raise unrelated storied error, because of checkout of depth 1
          git fetch origin --unshallow
          git checkout master
          git pull
          git merge --no-ff ${CANDIDATE}
      - name: Run checks
        run: ./scripts/run-checks.sh
